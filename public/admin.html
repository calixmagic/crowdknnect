<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magic Lab Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #logo-container {
            width: 80vw;
            max-width: 400px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            transition: transform 0.2s ease-out;
        }

        #settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            text-align: left;
        }

        #settings-panel.open {
            display: flex;
        }

        .section-title {
            font-size: 10px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 20px 0 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-link {
            color: #007aff;
            text-transform: none;
            letter-spacing: 0;
            font-size: 12px;
            cursor: pointer;
        }

        .row {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }

        input,
        select {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            width: 100%;
        }

        #steps-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step-item {
            background: #151515;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: grab;
            transition: background 0.2s;
        }

        .step-add-form {
            background: #0d1117;
            border: 1px dashed #007aff;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .step-add-form select,
        .step-add-form input {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            flex: 1;
            min-width: 80px;
        }

        .step-add-form button {
            background: #34c759;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .step-delete {
            color: #666;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
        }

        .step-item.dragging {
            opacity: 0.5;
            background: #222;
        }

        .step-handle {
            color: #444;
            font-size: 20px;
            cursor: grab;
        }

        .step-info {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .step-meta {
            font-size: 11px;
            color: #666;
        }

        .step-toggle {
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
        }

        .step-toggle.active {
            background: #34c759;
        }

        .step-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            transition: 0.2s;
        }

        .step-toggle.active::after {
            left: 22px;
        }

        .btn {
            background: #007aff;
            color: #fff;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
        }

        .btn-secondary {
            background: #222;
            border: 1px solid #333;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            margin-top: -7px;
        }

        #debug-log {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 90%;
            height: 60px;
            pointer-events: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 3000;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-family: monospace;
            text-align: left;
            line-height: 1.3;
        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #666;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #34c759;
        }

        input:checked+.slider:before {
            background-color: white;
            transform: translateX(20px);
        }

        #media-display {
            width: 85%;
            max-width: 500px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .white-bg {
            background-color: #fff !important;
            color: #000 !important;
        }

        .flash-bg {
            background-color: #fff !important;
        }

        .blackout-bg {
            background-color: #000 !important;
        }

        /* Heart morphing animation */
        #heart-svg {
            position: absolute;
            width: 100px;
            height: 100px;
            display: none;
        }

        #heart-svg.active {
            display: block;
            animation: heartMorph 3s ease-in-out forwards;
        }

        @keyframes heartMorph {
            0% {
                transform: scale(0.1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Countdown */
        #countdown-display {
            position: absolute;
            font-size: 30vh;
            font-weight: bold;
            color: #fff;
            display: none;
            animation: countdownPulse 1s infinite;
        }

        @keyframes countdownPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        /* Dice 3D */
        #dice-container {
            position: absolute;
            width: 200px;
            height: 200px;
            perspective: 800px;
            display: none;
        }

        #dice {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: diceRoll 2s ease-out forwards;
        }

        .dice-face {
            position: absolute;
            width: 200px;
            height: 200px;
            background: #fff;
            border: 3px solid #333;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: bold;
        }

        .dice-face:nth-child(1) {
            transform: rotateY(0deg) translateZ(100px);
        }

        .dice-face:nth-child(2) {
            transform: rotateY(180deg) translateZ(100px);
        }

        .dice-face:nth-child(3) {
            transform: rotateY(90deg) translateZ(100px);
        }

        .dice-face:nth-child(4) {
            transform: rotateY(-90deg) translateZ(100px);
        }

        .dice-face:nth-child(5) {
            transform: rotateX(90deg) translateZ(100px);
        }

        .dice-face:nth-child(6) {
            transform: rotateX(-90deg) translateZ(100px);
        }

        @keyframes diceRoll {
            0% {
                transform: rotate3d(1, 1, 1, 0deg);
            }

            100% {
                transform: rotate3d(1, 1, 1, 720deg);
            }
        }

        /* Ripple from logo */
        #ripple-overlay {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: none;
            pointer-events: none;
        }

        #ripple-overlay.active {
            animation: rippleExpand 2s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(30);
                opacity: 0;
            }
        }

        #audio-player {
            display: none;
        }

        /* Phase 2 Steps */
        #text-display {
            position: absolute;
            font-size: 12vh;
            font-weight: bold;
            color: #fff;
            text-align: center;
            max-width: 90%;
            display: none;
        }

        body.pulse-bg {
            animation: pulseEffect 1.5s ease-in-out infinite !important;
        }

        @keyframes pulseEffect {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        #spiral-overlay {
            position: absolute;
            width: 300px;
            height: 300px;
            border: 5px solid #fff;
            border-radius: 50%;
            display: none;
        }

        #spiral-overlay.active {
            animation: spiralSpin 3s linear infinite;
        }

        @keyframes spiralSpin {
            0% {
                transform: rotate(0deg) scale(0.5);
            }

            50% {
                transform: rotate(180deg) scale(1.5);
            }

            100% {
                transform: rotate(360deg) scale(0.5);
            }
        }

        #color-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            transition: background-color 0.5s;
        }

        #number-display {
            position: absolute;
            font-size: 25vh;
            font-weight: bold;
            color: #fff;
            display: none;
        }

        body.breathing-bg {
            animation: breatheEffect 4s ease-in-out infinite !important;
        }

        @keyframes breatheEffect {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        body.glitch-bg {
            animation: glitchEffect 0.3s infinite !important;
        }

        @keyframes glitchEffect {
            0% {
                transform: translate(0);
                filter: hue-rotate(0deg);
            }

            20% {
                transform: translate(-2px, 2px);
                filter: hue-rotate(90deg);
            }

            40% {
                transform: translate(2px, -2px);
                filter: hue-rotate(180deg);
            }

            60% {
                transform: translate(-2px, -2px);
                filter: hue-rotate(270deg);
            }

            80% {
                transform: translate(2px, 2px);
                filter: hue-rotate(360deg);
            }

            100% {
                transform: translate(0);
                filter: hue-rotate(0deg);
            }
        }

        #ripple-center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 50px;
            height: 50px;
            margin-left: -25px;
            margin-top: -25px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: none;
        }

        #ripple-center.active {
            animation: rippleCenterExpand 2s ease-out forwards;
        }

        @keyframes rippleCenterExpand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(30);
                opacity: 0;
            }
        }

        body.zoom-bg {
            animation: zoomEffect 3s ease-in-out forwards !important;
        }

        @keyframes zoomEffect {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(3);
            }
        }

        body.shake-bg {
            animation: shakeEffect 0.5s infinite !important;
        }

        @keyframes shakeEffect {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        #fade-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            transition: opacity 2s;
        }

        #fade-overlay.active {
            opacity: 1;
        }

        /* Phase 3 Advanced */
        #card-flip-container {
            position: absolute;
            width: 300px;
            height: 450px;
            perspective: 1000px;
            display: none;
        }

        #card-flip {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            animation: cardFlipAnim 2s ease-in-out forwards;
        }

        @keyframes cardFlipAnim {
            0% {
                transform: rotateY(0deg);
            }

            100% {
                transform: rotateY(180deg);
            }
        }

        #slot-container {
            position: absolute;
            display: none;
            font-size: 15vh;
        }

        #pinpoint-target {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 5px solid #f00;
            border-radius: 50%;
            display: none;
            animation: pinpointShrink 3s ease-in forwards;
        }

        @keyframes pinpointShrink {
            0% {
                transform: scale(5);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #unlock-icon {
            position: absolute;
            font-size: 20vh;
            display: none;
            animation: unlockAnim 2s ease-out forwards;
        }

        body.mirror-h {
            transform: scaleX(-1);
        }

        body.mirror-v {
            transform: scaleY(-1);
        }

        #wave-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent, rgba(0, 150, 255, 0.5));
            display: none;
            animation: waveMove 3s ease-in-out infinite;
        }

        @keyframes waveMove {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-30px);
            }
        }

        .sparkle-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            animation: sparklefall 2s linear forwards;
        }

        @keyframes sparklefall {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(100vh);
            }
        }

        #fire-container {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            display: none;
            background: linear-gradient(to top, #ff4500, #ff8c00, transparent);
            animation: fireFlicker 0.3s infinite alternate;
        }

        @keyframes fireFlicker {
            0% {
                opacity: 0.8;
                transform: scaleY(1);
            }

            100% {
                opacity: 1;
                transform: scaleY(1.1);
            }
        }

        body.beat-flash {
            animation: beatFlash 0.3s ease-in-out !important;
        }

        @keyframes beatFlash {

            0%,
            100% {
                background-color: inherit;
            }

            50% {
                background-color: #fff;
            }
        }

        #static-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, #000 0px, #fff 2px, #000 4px);
            display: none;
            animation: staticFlicker 0.1s infinite;
        }

        @keyframes staticFlicker {
            0% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        #eye-container {
            position: absolute;
            font-size: 20vh;
            display: none;
        }

        #puzzle-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
        }

        .puzzle-piece {
            position: absolute;
            width: 50%;
            height: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
        }

        #mask-overlay {
            position: absolute;
            font-size: 30vh;
            display: none;
            animation: maskAppear 2s ease-out forwards;
        }

        @keyframes maskAppear {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        #crystal-ball {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8), rgba(100, 100, 255, 0.4));
            display: none;
            animation: crystalGlow 2s ease-in-out infinite;
        }

        @keyframes crystalGlow {

            0%,
            100% {
                box-shadow: 0 0 20px #fff, 0 0 40px #88f;
            }

            50% {
                box-shadow: 0 0 40px #fff, 0 0 80px #88f;
            }
        }

        #snapshot-flash {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #fff;
            display: none;
        }

        #snapshot-flash.active {
            animation: cameraFlash 0.5s ease-out forwards;
        }

        @keyframes cameraFlash {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: starMove 3s linear infinite;
        }

        @keyframes starMove {
            0% {
                transform: translateZ(0) scale(1);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateZ(100px) scale(3);
                opacity: 0;
            }
        }

        .red {
            color: #f00 !important;
        }

        .black {
            color: #fff !important;
        }

        #step-guide {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        #step-guide.visible {
            display: block;
        }

        #step-guide .guide-content {
            max-width: 900px;
            margin: 0 auto;
            background: #2a2a2a;
            border: 2px solid #d9534f;
            border-radius: 12px;
            padding: 30px;
            position: relative;
        }

        #step-guide .guide-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #d9534f;
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        #step-guide .guide-close:hover {
            background: #c9302c;
            transform: scale(1.1);
        }

        #step-guide h3 {
            color: #d9534f;
            margin: 0 0 15px 0;
            font-size: 18px;
            border-bottom: 2px solid #d9534f;
            padding-bottom: 10px;
        }

        #step-guide table {
            width: 100%;
            border-collapse: collapse;
        }

        #step-guide td {
            padding: 6px 8px;
            border-bottom: 1px solid #2a2a2a;
        }

        #step-guide td:first-child {
            width: 80px;
            font-weight: bold;
            color: #888;
        }

        .guide-toggle {
            cursor: pointer;
            color: #fff;
            background: #d9534f;
            font-size: 16px;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 6px;
            margin-left: 12px;
            user-select: none;
            border: 2px solid #c9302c;
            transition: all 0.2s;
            display: inline-block;
        }

        .guide-toggle:hover {
            background: #c9302c;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(217, 83, 79, 0.6);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div id="debug-log">Admin init...</div>

    <div id="logo-screen" class="screen">
        <div id="logo-container"><img id="logo-img" src="" alt="Logo"></div>
        <p id="admin-tagline"
            style="color:#fff; font-size:0.8rem; letter-spacing:2px; text-transform:uppercase; text-align:center; padding:0 20px;">
            R√©aliser une exp√©rience.
        </p>
    </div>

    <!-- Pr√©visualisation s√©quence (Admin voit ce que le public voit) -->
    <div id="engine-screen" class="screen" style="display:none;justify-content:center;align-items:center;z-index:500;">
        <div id="emoji-display" style="font-size:15vh;"></div>
        <img id="media-display" src="" alt="Media">
        <video id="video-display" playsinline style="width:100%;height:100%;object-fit:cover;display:none;"></video>
        <img id="arrow" src="fleche.png" alt=""
            style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);display:none;width:50vw;max-width:350px;pointer-events:none;">
        <svg id="heart-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <path fill="#ff0000" d="M50,30 C50,30 50,30 50,30 C50,30 50,30 50,30 Z">
                <animate attributeName="d" dur="2s" fill="freeze" from="M50,50 L50,50 L50,50 Z"
                    to="M50,85 C25,70 15,55 15,40 C15,25 25,15 40,15 C45,15 50,20 50,20 C50,20 55,15 60,15 C75,15 85,25 85,40 C85,55 75,70 50,85 Z" />
            </path>
        </svg>
        <div id="countdown-display"></div>
        <div id="dice-container">
            <div id="dice">
                <div class="dice-face">1</div>
                <div class="dice-face">2</div>
                <div class="dice-face">3</div>
                <div class="dice-face">4</div>
                <div class="dice-face">5</div>
                <div class="dice-face">6</div>
            </div>
        </div>
        <div id="ripple-overlay"></div>
        <audio id="audio-player"></audio>
        <div id="text-display"></div>
        <div id="spiral-overlay"></div>
        <div id="color-overlay"></div>
        <div id="number-display"></div>
        <div id="ripple-center"></div>
        <div id="fade-overlay"></div>
        <div id="card-flip-container">
            <div id="card-flip"></div>
        </div>
        <div id="slot-container"></div>
        <div id="pinpoint-target"></div>
        <div id="unlock-icon">üîí</div>
        <div id="wave-overlay"></div>
        <div id="fire-container"></div>
        <div id="static-overlay"></div>
        <div id="eye-container">üëÅÔ∏è</div>
        <div id="puzzle-container"></div>
        <div id="mask-overlay">üé≠</div>
        <div id="crystal-ball"></div>
        <div id="snapshot-flash"></div>
    </div>

    <div id="settings-panel">
        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:20px;">
            <h2>Magic Lab</h2>
            <div id="connection-count"
                style="font-size:12px; background:#222; padding:4px 10px; border-radius:20px; color:#34c759;">üë§ 1</div>
        </div>



        <div class="header">
            <h1>CrowdConnect Admin</h1>
            <div class="row"><label>Routine Active <span class="add-link" onclick="addRoutine()">+
                        Nouvelle</span></label>
                <select id="routine-select" onchange="switchRoutine(this.value)"></select>
            </div>

            <div class="section-title">√âtapes de la s√©quence <span class="add-link" onclick="showAddStepForm()">+
                    Ajouter</span><span class="guide-toggle" onclick="toggleGuide()">‚ùì Guide</span></div>
            <div id="step-guide">
                <div class="guide-content">
                    <button class="guide-close" onclick="toggleGuide()">√ó</button>
                    <h3>üìã Guide des types d'√©tapes</h3>
                    <table>
                        <tr>
                            <td>‚¨á Arrow</td>
                            <td>Fl√®che rouge en bas d'√©cran</td>
                        </tr>
                        <tr>
                            <td>üîä Audio</td>
                            <td>Audio avec fade volume (startVol‚ÜíendVol)</td>
                        </tr>
                        <tr>
                            <td>üéµ Beat</td>
                            <td>Flash au rythme d'un BPM</td>
                        </tr>
                        <tr>
                            <td>‚¨õ Blackout</td>
                            <td>√âcran noir total</td>
                        </tr>
                        <tr>
                            <td>ü´Å Breathing</td>
                            <td>Animation respiration Zen</td>
                        </tr>
                        <tr>
                            <td>üé¥ CardFlip</td>
                            <td>Carte 3D qui se retourne</td>
                        </tr>
                        <tr>
                            <td>üé® Color</td>
                            <td>Couleur de fond personnalis√©e</td>
                        </tr>
                        <tr>
                            <td>üî¢ Countdown</td>
                            <td>Compte √† rebours (startFrom: 3-10)</td>
                        </tr>
                        <tr>
                            <td>üîÆ Crystal</td>
                            <td>Boule de cristal luminescente</td>
                        </tr>
                        <tr>
                            <td>üé≤ Dice</td>
                            <td>D√© 3D ‚Üí face finale (finalFace: 1-6)</td>
                        </tr>
                        <tr>
                            <td>üÉè Emojis</td>
                            <td>Symboles de cartes acc√©l√©r√©s (‚ô†‚ô•‚ô£‚ô¶)</td>
                        </tr>
                        <tr>
                            <td>üëÅÔ∏è Eye</td>
                            <td>≈íil qui cligne</td>
                        </tr>
                        <tr>
                            <td>üå´Ô∏è Fade</td>
                            <td>Fondu vers noir ou blanc</td>
                        </tr>
                        <tr>
                            <td>üî• Fire</td>
                            <td>Flammes montantes</td>
                        </tr>
                        <tr>
                            <td>‚ö° Flash</td>
                            <td>Flash blanc + vibration (500ms)</td>
                        </tr>
                        <tr>
                            <td>‚ö° Glitch</td>
                            <td>Effet matrix/bug visuel</td>
                        </tr>
                        <tr>
                            <td>‚ù§Ô∏è Heart</td>
                            <td>Animation morphing point ‚Üí c≈ìur battant</td>
                        </tr>
                        <tr>
                            <td>üéÜ Lottie</td>
                            <td>Animation Lottie JSON</td>
                        </tr>
                        <tr>
                            <td>üé≠ Mask</td>
                            <td>Masque qui appara√Æt</td>
                        </tr>
                        <tr>
                            <td>ü™û Mirror</td>
                            <td>Effet miroir horizontal/vertical</td>
                        </tr>
                        <tr>
                            <td>üî¢ Number</td>
                            <td>Nombre qui d√©file puis s'arr√™te</td>
                        </tr>
                        <tr>
                            <td>‚è∏ Pause</td>
                            <td>Pause configurable (d√©faut 2s)</td>
                        </tr>
                        <tr>
                            <td>üéØ Pinpoint</td>
                            <td>Cible qui se resserre sur un point</td>
                        </tr>
                        <tr>
                            <td>üíì Pulse</td>
                            <td>Pulsation hypnotique de l'√©cran</td>
                        </tr>
                        <tr>
                            <td>üß© Puzzle</td>
                            <td>Pi√®ces de puzzle qui s'assemblent</td>
                        </tr>
                        <tr>
                            <td>üé¥ Reveal</td>
                            <td>R√©v√©lation d'UNE carte (ex: 9C)</td>
                        </tr>
                        <tr>
                            <td>üñºÔ∏è RevealImage</td>
                            <td>R√©v√©lation d'une image/photo (URL)</td>
                        </tr>
                        <tr>
                            <td>„Ä∞Ô∏è Ripple</td>
                            <td>Ondulation depuis le centre</td>
                        </tr>
                        <tr>
                            <td>„Ä∞Ô∏è RippleFromLogo</td>
                            <td>Ondulation depuis le logo</td>
                        </tr>
                        <tr>
                            <td>üì£ Shake</td>
                            <td>Tremblement de l'√©cran</td>
                        </tr>
                        <tr>
                            <td>üîÄ Shuffle</td>
                            <td>M√©lange rapide de cartes</td>
                        </tr>
                        <tr>
                            <td>üîá Silence</td>
                            <td>Coupe tous les sons</td>
                        </tr>
                        <tr>
                            <td>üé∞ Slot</td>
                            <td>Machine √† sous (3 symboles)</td>
                        </tr>
                        <tr>
                            <td>üì∏ Snapshot</td>
                            <td>Flash cam√©ra + freeze frame</td>
                        </tr>
                        <tr>
                            <td>‚ú® Sparkle</td>
                            <td>Paillettes qui tombent</td>
                        </tr>
                        <tr>
                            <td>üåÄ Spiral</td>
                            <td>Spirale tournante hypnotique</td>
                        </tr>
                        <tr>
                            <td>üåü Starfield</td>
                            <td>Champ d'√©toiles en mouvement</td>
                        </tr>
                        <tr>
                            <td>üìª StaticNoise</td>
                            <td>Bruit blanc TV/static</td>
                        </tr>
                        <tr>
                            <td>‚èπ Stop</td>
                            <td>Stoppe la s√©quence (reset manuel)</td>
                        </tr>
                        <tr>
                            <td>üìù Text</td>
                            <td>Texte g√©ant personnalisable</td>
                        </tr>
                        <tr>
                            <td>üîì Unlock</td>
                            <td>Cadenas qui s'ouvre</td>
                        </tr>
                        <tr>
                            <td>üé¨ Video</td>
                            <td>Vid√©o plein √©cran (URL)</td>
                        </tr>
                        <tr>
                            <td>üåä Wave</td>
                            <td>Vague liquide qui traverse l'√©cran</td>
                        </tr>
                        <tr>
                            <td>üî§ Words</td>
                            <td>Lettres ‚Üí mots ‚Üí MOT FINAL</td>
                        </tr>
                        <tr>
                            <td>üîç Zoom</td>
                            <td>Zoom progressif sur l'√©cran</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="step-add-area"></div>
            <div id="steps-list"></div>

            <div class="section-title">Configuration Globale</div>
            <div class="row"><label>D√©lai d'Entr√©e (s)</label><input type="number" id="delay-input" value="2"
                    step="0.5">
            </div>
            <div class="row"><label>Zoom Logo (<span id="zoom-val">100</span>%)</label><input type="range"
                    id="zoom-range" min="50" max="250" value="100" oninput="updateZoom(this.value)"></div>
            <div class="row"><label>Logo : Galerie</label>
                <div class="file-input-wrapper"><button class="btn btn-secondary">CHOISIR IMAGE</button><input
                        type="file" id="logo-file" accept="image/*" onchange="handleFileUpload(this)"></div>
            </div>
            <div class="row"><label>Logo : URL</label><input type="text" id="logo-url-input" placeholder="https://..."
                    oninput="previewLogo(this.value)"></div>
            <div class="row"><label>URL Redirection Finale</label><input type="text" id="redir-url-input"
                    placeholder="https://g.page/..."></div>
            <div class="row"><label>Texte d'accueil</label><input type="text" id="tagline-input"
                    placeholder="R√©aliser une exp√©rience."></div>
            <div class="row">
                <label for="logs-toggle">Afficher les logs de timing (Admin)</label>
                <label class="switch" style="margin:0;">
                    <input type="checkbox" id="logs-toggle" onchange="toggleLogs(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="row">
                <label for="toggle-debug">Mode Debug (Visible sur public)</label>
                <label class="switch" style="margin:0;">
                    <input type="checkbox" id="toggle-debug">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="row">
                <div class="setting-row">
                    <label for="bg-color-input">Couleur de fond:</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="color" id="bg-color-input" onchange="setBgColor(this.value)">
                        <button onclick="autoColorFromLogo()"
                            style="font-size:12px; padding:2px 8px; border:1px solid #555; background:#333; color:#fff; border-radius:4px; cursor:pointer;"
                            title="Extraire du logo">üé® Auto</button>
                    </div>
                </div>
                <div class="setting-row">
                    <label for="bg-anim-select">Animation de fond:</label>
                    <select id="bg-anim-select" onchange="setBgAnim(this.value)" style="padding:5px;border-radius:4px;">
                        <option value="none">Aucune</option>
                        <option value="particles">Particules</option>
                        <option value="gradient">D√©grad√©</option>
                        <option value="stars">√âtoiles</option>
                        <option value="matrix">Matrix</option>
                        <option value="fireflies">Lucioles</option>
                        <option value="bokeh">Bokeh</option>
                        <option value="plasma">Plasma</option>
                        <option value="snow">Neige</option>
                        <option value="rain">Pluie</option>
                        <option value="geometric">G√©om√©trique</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label for="start-anim-select">Anim. D√©part:</label>
                    <select id="start-anim-select" onchange="setStartAnim(this.value)"
                        style="padding:5px;border-radius:4px;">
                        <option value="fade">Fondu (D√©faut)</option>
                        <option value="zoom">Zoom</option>
                        <option value="slide">Glisser Haut</option>
                        <option value="none">Aucune</option>
                    </select>
                </div>
            </div>

            <div class="section-title">Outils</div>
            <div class="row" style="flex-direction:column;align-items:flex-start;">
                <label>G√©n√©rateur QR Code (Vers Public)</label>
                <div style="display:flex;gap:20px;margin-top:10px;align-items:flex-start;width:100%;">
                    <div id="qr-container"
                        style="background:#fff;padding:15px;border-radius:12px;min-width:200px;min-height:200px;display:flex;justify-content:center;align-items:center;">
                        <span style="color:#ccc;font-size:12px;">QR Code ici</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:10px;flex:1;">
                        <p style="font-size:12px;color:#aaa;margin-bottom:5px;">Le QR dirigera vers l'URL actuelle (sans
                            /admin.html). Le logo actif sera incrust√©.</p>
                        <button class="btn btn-secondary" onclick="generateQR()">üîÑ G√©n√©rer</button>
                        <button class="btn btn-secondary" onclick="downloadQR()"
                            style="background:#34c759;color:#fff;">üíæ T√©l√©charger HD</button>
                    </div>
                </div>
                <canvas id="qr-canvas" style="display:none;"></canvas>
            </div>

            <button class="btn" style="background:#34c759" onclick="saveAll()">SYNCHRONISER &
                ENREGISTRER</button>
            <button class="btn btn-secondary" onclick="closePanel()">FERMER PANNEAU</button>
        </div>
    </div>
    <!-- End of Settings Panel -->

    <div id="wrapper">
        <!-- Background Preview Canvas -->
        <canvas id="bg-canvas"
            style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none;" width="430"
            height="932"></canvas>
        <div id="bg-overlay-css"
            style="position: fixed; top: 0px; left: 0px; width: 100%; height: 100%; z-index: -1; pointer-events: none;"
            class="">
        </div>

        <div class="header">
            <h1>CrowdConnect Admin</h1>
            <button id="msg-btn"
                style="position:absolute; top:20px; right:20px; font-size:24px; background:none; border:none; cursor:pointer;"
                onclick="openSettings()">‚öôÔ∏è</button>
        </div>

        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
        <script>
            const socket = io();
            let state = { routines: [], activeRoutineIndex: 0, sequenceDelay: 2, logoZoom: 100, logoUrl: '', redirectionUrl: '', logoVisible: false, tagline: '', bgAnim: 'none', startAnim: 'fade' };
            let lpTimer = null;
            let showStep = 0;
            let serverOffset = 0;
            const logBox = document.getElementById('debug-log');

            // Init logs toggle from localStorage
            const savedLogState = localStorage.getItem('adminLogsParams') === 'true';
            const logToggle = document.getElementById('logs-toggle');
            if (logToggle) {
                logToggle.checked = savedLogState;
                toggleLogs(savedLogState);
            }

            function log(msg, color) {
                const time = new Date().toLocaleTimeString();
                console.log(`[ADMIN ${time}] ${msg}`);
                if (!logBox) return;
                const line = document.createElement('div');
                line.style.color = color || "rgba(255,255,255,0.5)";
                line.innerText = `[${time}] ${msg}`;
                logBox.appendChild(line);
                if (logBox.childNodes.length > 5) logBox.removeChild(logBox.firstChild);
            }

            // === QR CODE GENERATOR ===
            let qrCodeObj = null;

            function generateQR() {
                const url = window.location.href.replace('admin.html', '').split('#')[0]; // Public URL root
                console.log("Generating QR for: " + url);
                const container = document.getElementById('qr-container');
                container.innerHTML = '';

                // Generate QR
                qrCodeObj = new QRCode(container, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Wait for generation then prepare canvas
                setTimeout(() => prepareHQCanvas(), 100);
            }

            function prepareHQCanvas() {
                // Logic to draw QR + Logo on hidden canvas for HD download
                const qrImg = document.querySelector('#qr-container img');
                if (!qrImg) return;

                const canvas = document.getElementById('qr-canvas');
                const ctx = canvas.getContext('2d');

                // High Res Canvas (1024x1024)
                canvas.width = 1024;
                canvas.height = 1024;

                const img = new Image();
                img.src = qrImg.src;
                img.onload = () => {
                    // Fill white background
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, 1024, 1024);

                    // Draw QR Scaled
                    ctx.drawImage(img, 0, 0, 1024, 1024);

                    // Draw Logo if exists
                    const logoImgTag = document.getElementById('logo-img');
                    if (logoImgTag && logoImgTag.src && logoImgTag.src !== window.location.href) {
                        const logo = new Image();
                        logo.crossOrigin = "Anonymous";
                        logo.src = logoImgTag.src;

                        logo.onload = () => {
                            // Center logo, 20% size
                            const s = 220;
                            const x = (1024 - s) / 2;
                            const y = (1024 - s) / 2;

                            // White circle bg for logo
                            ctx.beginPath();
                            ctx.arc(512, 512, s / 2 + 20, 0, 2 * Math.PI);
                            ctx.fillStyle = "#ffffff";
                            ctx.fill();

                            // Draw Logo
                            ctx.drawImage(logo, x, y, s, s);
                        }
                        // Handle error if logo fails to load (e.g. invalid URL)
                        logo.onerror = () => console.log("Logo load failed for QR");
                    }
                }
            }

            function downloadQR() {
                const canvas = document.getElementById('qr-canvas');
                // Ensure canvas is ready (re-run prepare just in case)
                if (canvas.width === 0) {
                    alert("Veuillez g√©n√©rer le QR Code d'abord.");
                    return;
                }

                const link = document.createElement('a');
                link.download = 'crowdconnect-qr-hd.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            function toggleLogs(checked) {
                if (logBox) logBox.style.display = checked ? 'block' : 'none';
                localStorage.setItem('adminLogsParams', checked);
            }

            socket.on('connect', () => {
                log("VERSION: v4.1 - Admin UI Fix", "#00adff");
                log("Socket connect√©: " + socket.id, "#34c759");
                const now = Date.now();
                socket.emit('sync-time', now, (serverTime) => {
                    const latency = (Date.now() - now) / 2;
                    serverOffset = serverTime - (Date.now() - latency);
                });
            });
            socket.on('disconnect', () => log("Socket d√©connect√©!", "#f00"));

            socket.on('state-update', (serverState) => {
                log("Sync: " + (serverState.routines ? serverState.routines.length : 0) + " routines re√ßues");
                state = serverState;
                updateUI();
            });

            socket.on('spectator-count', (data) => {
                const el = document.getElementById('connection-count');
                if (el) el.innerText = "üë§ " + data.count;
                log("Spectateurs: " + data.count);
            });

            socket.on('admin-granted', () => {
                log("Admin accord√©!", "#34c759");
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            });

            function updateUI() {
                const img = document.getElementById('logo-img');
                if (state.logoUrl) {
                    img.src = state.logoUrl; img.style.display = 'block';
                    img.style.transform = `scale(${(state.logoZoom || 100) / 100})`;
                } else { img.style.display = 'none'; }
                // showStep avance d√®s que logoVisible est true (m√™me sans logo image)
                showStep = state.logoVisible ? 1 : 0;

                document.getElementById('delay-input').value = state.sequenceDelay || 2;
                document.getElementById('zoom-range').value = state.logoZoom || 100;
                document.getElementById('zoom-val').innerText = state.logoZoom || 100;
                document.getElementById('logo-url-input').value = state.logoUrl || '';
                document.getElementById('redir-url-input').value = state.redirectionUrl || '';
                document.getElementById('tagline-input').value = state.tagline || '';
                const adminTagline = document.getElementById('admin-tagline');
                if (adminTagline && state.tagline) adminTagline.innerText = state.tagline;
                // Background color & Anim
                document.getElementById('bg-color-input').value = state.bgColor || '#000000';
                document.getElementById('logo-screen').style.background = state.bgColor || '#000';
                document.getElementById('bg-anim-select').value = state.bgAnim || 'none';
                document.getElementById('start-anim-select').value = state.startAnim || 'fade';
                // Trigger preview
                setBgAnimationPreview(state.bgAnim || 'none', state.bgColor || '#000000');


                // Sync debug toggle
                const debugToggle = document.getElementById('toggle-debug');
                if (debugToggle) debugToggle.checked = !!state.debug;

                const sel = document.getElementById('routine-select');
                if (state.routines && state.routines.length > 0) {
                    sel.innerHTML = state.routines.map((r, i) => `<option value="${i}" ${i == state.activeRoutineIndex ? 'selected' : ''}>${r.name}</option>`).join('');
                    renderSteps();
                } else {
                    sel.innerHTML = '<option>Aucune routine</option>';
                    document.getElementById('steps-list').innerHTML = '<p style="color:#444;font-size:12px;">Aucune routine. Cliquez "+ Nouvelle".</p>';
                }
            }

            function setBgColor(color) {
                document.getElementById('bg-color-input').value = color;
                document.getElementById('logo-screen').style.background = color;
                state.bgColor = color;
                socket.emit('update-state', state);
                // Update preview if active
                if (state.bgAnim && state.bgAnim !== 'none') setBgAnimationPreview(state.bgAnim, color);
            }

            function setBgAnim(anim) {
                state.bgAnim = anim;
                socket.emit('update-state', state);
                setBgAnimationPreview(anim, state.bgColor || '#000000');
            }

            function setStartAnim(anim) {
                state.startAnim = anim;
                socket.emit('update-state', state);
            }

            function autoColorFromLogo() {
                const img = document.getElementById('logo-img');
                if (!img || !img.src || img.style.display === 'none') {
                    alert("Aucun logo charg√©.");
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1;
                canvas.height = 1;

                // Allow cross-origin if possible (might fail for some external URLs without CORS)
                try {
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const p = ctx.getImageData(0, 0, 1, 1).data;
                    const hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
                    setBgColor(hex);
                    log("Couleur extraite: " + hex, hex);
                } catch (e) {
                    console.error(e);
                    alert("Impossible d'extraire la couleur (CORS ?)");
                }
            }

            function rgbToHex(r, g, b) {
                if (r > 255 || g > 255 || b > 255)
                    throw "Invalid color component";
                return ((r << 16) | (g << 8) | b).toString(16);
            }



            let lastRenderedSteps = '';

            function renderSteps() {
                const list = document.getElementById('steps-list');
                const currentScroll = list.scrollTop; // Save scroll position
                const routine = state.routines[state.activeRoutineIndex];

                if (!routine) { list.innerHTML = '<p style="color:#444;font-size:12px;">Routine invalide.</p>'; return; }

                // Optimization: Skip render if steps haven't changed
                const newStepsJSON = JSON.stringify(routine.steps);
                if (newStepsJSON === lastRenderedSteps) {
                    // Render skipped. Log to console only, not visual log to avoid spam
                    if (state.debug) console.log("Render skipped: No changes");
                    return;
                }
                lastRenderedSteps = newStepsJSON;

                // Always log for debug purposes per user request
                log(`[Render] Refreshing list. Scroll: ${currentScroll}`);

                const icons = { emojis: 'üÉè', blackout: '‚¨õ', flash: '‚ö°', shuffle: 'üîÄ', reveal: 'üé¥', revealImage: 'üñºÔ∏è', video: 'üé¨', words: 'üî§', lottie: 'üéÜ', arrow: '‚¨á', heart: '‚ù§Ô∏è', countdown: 'üî¢', dice: 'üé≤', rippleFromLogo: '„Ä∞Ô∏è', audio: 'üîä', text: 'üìù', pulse: 'üíì', spiral: 'üåÄ', color: 'üé®', number: 'üî¢', breathing: 'ü´Å', glitch: '‚ö°', ripple: '„Ä∞Ô∏è', zoom: 'üîç', shake: 'üì£', fade: 'üå´Ô∏è', pause: '‚è∏', cardFlip: 'üé¥', slot: 'üé∞', pinpoint: 'üéØ', unlock: 'üîì', mirror: 'ü™û', wave: 'üåä', sparkle: '‚ú®', fire: 'üî•', beat: 'üéµ', silence: 'üîá', staticNoise: 'üìª', eye: 'üëÅÔ∏è', puzzle: 'üß©', mask: 'üé≠', crystal: 'üîÆ', snapshot: 'üì∏', starfield: 'üåü', stop: '‚èπ' };
                list.innerHTML = routine.steps.map((step, idx) => `
                <div class="step-item" draggable="true" data-idx="${idx}">
                    <div class="step-handle">‚ò∞</div>
                    <div class="step-info" onclick="editStep(${idx})">
                        <div class="step-name">${icons[step.type] || '‚ñ∂'} ${step.type.toUpperCase()}</div>
                        <div class="step-meta">${step.duration}ms ${step.value ? '| ' + step.value : ''} ${step.vibrate ? '| Vib' : ''}</div>
                    </div>
                    <div class="step-toggle ${step.active ? 'active' : ''}" onclick="event.stopPropagation(); toggleStep(${idx})"></div>
                </div>
            `).join('');

                // Touch drag for mobile (Reverted to Handle-Based)
                list.querySelectorAll('.step-item').forEach(item => {
                    const handle = item.querySelector('.step-handle');
                    let startY = 0, currentItem = null;

                    handle.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        currentItem = item;
                        startY = e.touches[0].clientY;
                        item.classList.add('dragging');
                        item.style.zIndex = '100';
                    }, { passive: false });

                    handle.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!currentItem) return;
                        const y = e.touches[0].clientY;
                        const after = getDragAfter(list, y);
                        if (!after) list.appendChild(currentItem);
                        else list.insertBefore(currentItem, after);
                    }, { passive: false });

                    handle.addEventListener('touchend', () => {
                        if (!currentItem) return;
                        currentItem.classList.remove('dragging');
                        currentItem.style.zIndex = '';
                        currentItem = null;

                        state.routines[state.activeRoutineIndex].steps = reordered;
                        syncState();
                        renderSteps();
                    });
                    // Desktop drag fallback (native HTML5 DnD)
                    item.addEventListener('dragstart', () => {
                        item.classList.add('dragging');
                    });
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        // Persist new order to state
                        const newOrder = [...list.querySelectorAll('.step-item')].map(el => parseInt(el.dataset.idx));
                        const steps = state.routines[state.activeRoutineIndex].steps;
                        const reordered = newOrder.map(i => steps[i]);
                        state.routines[state.activeRoutineIndex].steps = reordered;
                        syncState();
                        renderSteps();
                    });
                });

                // Container Drag Over (for Desktop)
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const dragging = list.querySelector('.dragging');
                    const after = getDragAfter(list, e.clientY);
                    if (!after) list.appendChild(dragging); else list.insertBefore(dragging, after);
                });

                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const dragging = list.querySelector('.dragging');
                    const after = getDragAfter(list, e.clientX); // Was clientY, but flex might be tricky? No, list is column.
                    // Wait, getDragAfter uses clientY.
                    const afterY = getDragAfter(list, e.clientY);
                    if (!afterY) list.appendChild(dragging); else list.insertBefore(dragging, afterY);
                });

                // Restore scroll position
                requestAnimationFrame(() => {
                    list.scrollTop = currentScroll;
                    if (state.debug) console.log(`[Render] Scroll restored to ${currentScroll}`);
                });
            }

            function getDragAfter(container, y) {
                const els = [...container.querySelectorAll('.step-item:not(.dragging)')];
                return els.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset, element: child };
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function addRoutine() {
                const name = prompt("Nom de la routine ?", "Nouveau Spectacle");
                if (!name) return;
                state.routines.push({ id: Date.now(), name, steps: [] });
                state.activeRoutineIndex = state.routines.length - 1;
                socket.emit('update-state', state);
                log("Routine cr√©√©e: " + name);
                updateUI();
            }

            function showAddStepForm() {
                if (!state.routines || !state.routines[state.activeRoutineIndex]) {
                    log("Erreur: Cr√©ez une routine d'abord", "#f00"); return;
                }
                document.getElementById('step-add-area').innerHTML = `
                <div class="step-add-form" style="display:flex; flex-direction:column; gap:8px; padding:10px; background:rgba(0,122,255,0.1); border-radius:8px;">
                    <div style="display:flex; gap:5px;">
                        <select id="new-step-type" style="flex:1;" onchange="updateNewStepPlaceholder()">
                            <option value="arrow">‚¨á Arrow</option>
                            <option value="audio">üîä Audio</option>
                            <option value="beat">üéµ Beat</option>
                            <option value="blackout">‚¨õ Blackout</option>
                            <option value="breathing">ü´Å Breathing</option>
                            <option value="cardFlip">üé¥ CardFlip</option>
                            <option value="color">üé® Color</option>
                            <option value="countdown">üî¢ Countdown</option>
                            <option value="crystal">üîÆ Crystal</option>
                            <option value="dice">üé≤ Dice</option>
                            <option value="emojis">üÉè Emojis</option>
                            <option value="eye">üëÅÔ∏è Eye</option>
                            <option value="fade">üå´Ô∏è Fade</option>
                            <option value="fire">üî• Fire</option>
                            <option value="flash">‚ö° Flash</option>
                            <option value="glitch">‚ö° Glitch</option>
                            <option value="heart">‚ù§Ô∏è Heart</option>
                            <option value="mask">üé≠ Mask</option>
                            <option value="mirror">ü™û Mirror</option>
                            <option value="number">üî¢ Number</option>
                            <option value="pause">‚è∏ Pause</option>
                            <option value="pinpoint">üéØ Pinpoint</option>
                            <option value="pulse">üíì Pulse</option>
                            <option value="puzzle">üß© Puzzle</option>
                            <option value="reveal">üé¥ Reveal</option>
                            <option value="revealImage">üñºÔ∏è RevealImage</option>
                            <option value="ripple">„Ä∞Ô∏è Ripple</option>
                            <option value="rippleFromLogo">„Ä∞Ô∏è RippleFromLogo</option>
                            <option value="shake">üì£ Shake</option>
                            <option value="shuffle">üîÄ Shuffle</option>
                            <option value="silence">üîá Silence</option>
                            <option value="slot">üé∞ Slot</option>
                            <option value="snapshot">üì∏ Snapshot</option>
                            <option value="sparkle">‚ú® Sparkle</option>
                            <option value="spiral">üåÄ Spiral</option>
                            <option value="starfield">üåü Starfield</option>
                            <option value="staticNoise">üìª StaticNoise</option>
                            <option value="text">üìù Text</option>
                            <option value="unlock">üîì Unlock</option>
                            <option value="video">üé¨ Video</option>
                            <option value="wave">üåä Wave</option>
                            <option value="words">üî§ Words</option>
                            <option value="zoom">üîç Zoom</option>
                            <option value="stop">‚èπ Stop</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-step-value" placeholder="Valeur / URL (Optionnel)" style="flex:2;">
                        <input type="number" id="new-step-duration" value="2000" placeholder="ms" style="width:70px;">
                        <button onclick="confirmAddStep()" style="background:#007aff;color:white;border:none;border-radius:4px;width:40px;font-weight:bold;">OK</button>
                    </div>
                </div>
            `;
                updateNewStepPlaceholder();
            }

            function updateNewStepPlaceholder() {
                const type = document.getElementById('new-step-type').value;
                const valInput = document.getElementById('new-step-value');
                if (!valInput) return;

                const placeholders = {
                    text: "Texte √† afficher",
                    audio: "URL audio (audio/file.mp3)",
                    video: "URL vid√©o (videos/file.mp4)",
                    color: "Code couleur (#ff0000)",
                    countdown: "D√©part (ex: 3)",
                    number: "Nombre final",
                    reveal: "Carte (ex: KH, AS)",
                    revealImage: "URL image",
                    words: "Mot final",
                    pinpoint: "X,Y (ex: 50,50)",
                    glitch: "Message glitch",
                    slot: "R√©sultat (‚≠ê‚≠ê‚≠ê)"
                };
                valInput.placeholder = placeholders[type] || "Valeur (Optionnel)";
            }

            function confirmAddStep() {
                const type = document.getElementById('new-step-type').value;
                const duration = parseInt(document.getElementById('new-step-duration').value) || 2000;
                const value = document.getElementById('new-step-value').value;

                const newStep = { id: Date.now(), type, duration, active: true };
                if (value) {
                    // Special handling for some types if needed, but generic assignment is usually fine
                    // For audio/video/lottie, map value to 'url' if it looks like a url, or just value if simple
                    if (['audio', 'video', 'lottie'].includes(type)) {
                        newStep.url = value;
                    } else if (type === 'pinpoint') {
                        // Try to parse "50,50"
                        const parts = value.split(',');
                        if (parts.length === 2) {
                            newStep.x = parseInt(parts[0].trim());
                            newStep.y = parseInt(parts[1].trim());
                        }
                    } else {
                        newStep.value = value;
                    }
                }

                state.routines[state.activeRoutineIndex].steps.push(newStep);
                log("Ajout: " + type);
                // Don't clear form completely, just value maybe? Or close it? 
                // User might want to add multiple similar steps. Let's keep it but clear value.
                // UX: Keep the form values (don't clear) to allow rapid addition of similar steps
                // document.getElementById('new-step-value').value = '';

                socket.emit('update-state', state);
                renderSteps();
            }

            async function uploadAudioFile(input, stepIdx) {
                const file = input.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('audioFile', file);

                const btn = input.previousElementSibling;
                const originalText = btn.innerText;
                btn.innerText = "UPLOADING...";
                btn.disabled = true;

                try {
                    const response = await fetch('/upload-audio', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Upload failed');

                    const data = await response.json();

                    // Mettre √† jour le champ URL
                    // Fix: robustly find the text input which is the previous sibling of the parent wrapper
                    const urlInput = input.parentElement.previousElementSibling;
                    if (urlInput) {
                        urlInput.value = data.path;
                    }

                    log("Audio upload√©: " + data.filename, "#34c759");
                    btn.innerText = "‚úÖ OK";
                    setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);

                } catch (error) {
                    console.error("Erreur upload:", error);
                    log("Erreur upload audio", "#f00");
                    btn.innerText = "ERREUR";
                    setTimeout(() => { btn.innerText = "UPLOAD FICHIER"; btn.disabled = false; }, 2000);
                }
            }


            async function uploadVideoFile(input, stepIdx) {
                const file = input.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('videoFile', file);

                const btn = input.previousElementSibling;
                const originalText = btn.innerText;
                btn.innerText = "UPLOADING...";
                btn.disabled = true;

                try {
                    const response = await fetch('/upload-video', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Upload failed');

                    const data = await response.json();

                    // Mettre √† jour le champ URL
                    const urlInput = input.parentElement.nextElementSibling; // L'input text est juste apr√®s le div wrapper
                    if (urlInput) {
                        urlInput.value = data.path;
                    }

                    log("Vid√©o upload√©e: " + data.filename, "#34c759");
                    btn.innerText = "‚úÖ OK";
                    setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);

                } catch (error) {
                    console.error("Erreur upload:", error);
                    log("Erreur upload vid√©o", "#f00");
                    btn.innerText = "ERREUR";
                    setTimeout(() => { btn.innerText = "UPLOAD FICHIER"; btn.disabled = false; }, 2000);
                }
            }
            // === BG PREVIEW LOGIC (Simplified from index.html) ===
            let bgCanvas = document.getElementById('bg-canvas');
            let bgCtx = bgCanvas.getContext('2d');
            let bgAnimFrameId = null;
            let bgParticles = [];

            function resizeBgCanvas() {
                bgCanvas.width = window.innerWidth;
                bgCanvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeBgCanvas);
            resizeBgCanvas();

            function setBgAnimationPreview(type, color) {
                cancelAnimationFrame(bgAnimFrameId);
                bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
                document.getElementById('bg-overlay-css').className = '';
                document.getElementById('bg-overlay-css').style = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;';
                bgParticles = [];

                if (type === 'none') return;
                // Map types to simpler preview functions if needed, or same logic
                // For now, let's implement the most visual ones
                switch (type) {
                    case 'particles': initParticles(color); break;
                    case 'gradient':
                        const cssEl = document.getElementById('bg-overlay-css');
                        cssEl.style.background = `linear-gradient(45deg, ${color}, #000, ${color})`;
                        cssEl.style.backgroundSize = '400% 400%';
                        cssEl.style.animation = 'gradientBG 15s ease infinite';
                        if (!document.getElementById('style-gradient')) {
                            const s = document.createElement('style');
                            s.id = 'style-gradient';
                            s.innerHTML = `@keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }`;
                            document.head.appendChild(s);
                        }
                        break;
                    case 'stars': initStarfield(); break;
                    case 'matrix': initMatrix(color); break;
                    case 'fireflies': initFireflies(color); break;
                    case 'bokeh': initBokeh(color); break;
                    case 'plasma': initPlasma(color); break;
                    case 'snow': initSnow(); break;
                    case 'rain': initRain(color); break;
                    case 'geometric': initGeometric(color); break;
                }
            }

            // --- Copied Animation Functions (Compressed for Admin) ---
            function initParticles(c) { for (let i = 0; i < 50; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, vx: (Math.random() - .5), vy: (Math.random() - .5), size: Math.random() * 3 + 1, alpha: Math.random() }); function l() { bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.fillStyle = c; bgParticles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0) p.x = bgCanvas.width; if (p.x > bgCanvas.width) p.x = 0; if (p.y < 0) p.y = bgCanvas.height; if (p.y > bgCanvas.height) p.y = 0; bgCtx.globalAlpha = p.alpha; bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); bgCtx.fill() }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initMatrix(c) { const cols = Math.floor(bgCanvas.width / 20); const ypos = Array(cols).fill(0); bgCtx.fillStyle = '#000'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height); function l() { bgCtx.fillStyle = '#0001'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.fillStyle = c || '#0f0'; bgCtx.font = '15pt monospace'; ypos.forEach((y, i) => { const t = String.fromCharCode(Math.random() * 128); const x = i * 20; bgCtx.fillText(t, x, y); if (y > 100 + Math.random() * 10000) ypos[i] = 0; else ypos[i] = y + 20 }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initStarfield() { for (let i = 0; i < 100; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, z: Math.random() * bgCanvas.width }); function l() { bgCtx.fillStyle = '#000'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.fillStyle = '#fff'; const cx = bgCanvas.width / 2, cy = bgCanvas.height / 2; bgParticles.forEach(p => { p.z -= 2; if (p.z <= 0) { p.z = bgCanvas.width; p.x = Math.random() * bgCanvas.width; p.y = Math.random() * bgCanvas.height } const k = 128 / p.z, x = (p.x - cx) * k + cx, y = (p.y - cy) * k + cy; if (x >= 0 && x < bgCanvas.width && y >= 0 && y < bgCanvas.height) { bgCtx.beginPath(); bgCtx.arc(x, y, (1 - p.z / bgCanvas.width) * 3, 0, Math.PI * 2); bgCtx.fill() } }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initFireflies(c) { for (let i = 0; i < 30; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, vx: (Math.random() - .5) * .5, vy: (Math.random() - .5) * .5, size: Math.random() * 2 + 1, phase: Math.random() * 6.28 }); function l() { bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgParticles.forEach(p => { p.x += p.vx; p.y += p.vy; p.phase += .05; const a = (Math.sin(p.phase) + 1) / 2 * .8 + .2; if (p.x < 0) p.x = bgCanvas.width; if (p.x > bgCanvas.width) p.x = 0; if (p.y < 0) p.y = bgCanvas.height; if (p.y > bgCanvas.height) p.y = 0; bgCtx.shadowBlur = 10; bgCtx.shadowColor = c; bgCtx.fillStyle = c; bgCtx.globalAlpha = a; bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); bgCtx.fill(); bgCtx.shadowBlur = 0 }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initBokeh(c) { for (let i = 0; i < 15; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, vx: (Math.random() - .5) * .2, vy: (Math.random() - .5) * .2, size: Math.random() * 50 + 20, alpha: Math.random() * .2 + .05 }); function l() { bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgParticles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < -100) p.x = bgCanvas.width + 100; if (p.x > bgCanvas.width + 100) p.x = -100; if (p.y < -100) p.y = bgCanvas.height + 100; if (p.y > bgCanvas.height + 100) p.y = -100; bgCtx.fillStyle = c; bgCtx.globalAlpha = p.alpha; bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); bgCtx.fill() }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initPlasma(c) { let t = 0; function l() { t += .01; bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.strokeStyle = c; bgCtx.lineWidth = 2; for (let i = 0; i < 5; i++) { bgCtx.beginPath(); for (let x = 0; x < bgCanvas.width; x += 10) { const y = bgCanvas.height / 2 + Math.sin(x * .01 + t + i) * 100 * Math.sin(t * .5); if (x === 0) bgCtx.moveTo(x, y); else bgCtx.lineTo(x, y) } bgCtx.stroke() } bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initSnow() { for (let i = 0; i < 100; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, vx: (Math.random() - .5) * .5, vy: Math.random() * 2 + 1, size: Math.random() * 2 + 1 }); function l() { bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.fillStyle = '#fff'; bgParticles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.y > bgCanvas.height) { p.y = -5; p.x = Math.random() * bgCanvas.width } bgCtx.beginPath(); bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); bgCtx.fill() }); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initRain(c) { for (let i = 0; i < 200; i++)bgParticles.push({ x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height, vy: Math.random() * 10 + 10, l: Math.random() * 20 + 10 }); function l() { bgCtx.fillStyle = '#0003'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.strokeStyle = c || '#0af'; bgCtx.lineWidth = 1; bgCtx.beginPath(); bgParticles.forEach(p => { p.y += p.vy; if (p.y > bgCanvas.height) { p.y = -p.l; p.x = Math.random() * bgCanvas.width } bgCtx.moveTo(p.x, p.y); bgCtx.lineTo(p.x, p.y + p.l) }); bgCtx.stroke(); bgAnimFrameId = requestAnimationFrame(l) } l() }
            function initGeometric(c) { let t = 0; function l() { t += .005; bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height); bgCtx.strokeStyle = c; bgCtx.lineWidth = 1; const cx = bgCanvas.width / 2, cy = bgCanvas.height / 2; for (let i = 0; i < 10; i++) { const s = 100 + i * 50; bgCtx.save(); bgCtx.translate(cx, cy); bgCtx.rotate(t * (i % 2 === 0 ? 1 : -1) + i * .1); bgCtx.strokeRect(-s / 2, -s / 2, s, s); bgCtx.restore() } bgAnimFrameId = requestAnimationFrame(l) } l() }

            // Settings Panel Logic
            function openSettings() {
                document.getElementById('settings-panel').classList.add('open');
            }

            function closePanel() {
                document.getElementById('settings-panel').classList.remove('open');
            }

            // === LONG PRESS TO OPEN SETTINGS (Admin) ===
            let settingsTimer = null;
            let sX = 0, sY = 0;

            document.addEventListener('touchstart', (e) => {
                // Ignore if touching a button or input
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.closest('.step-handle')) return;

                if (e.touches.length === 1) {
                    sX = e.touches[0].clientX;
                    sY = e.touches[0].clientY;
                    log(`Touch start: ${parseInt(sX)},${parseInt(sY)}`);

                    settingsTimer = setTimeout(() => {
                        log("Geste Admin d√©tect√©: Ouverture Param√®tres");
                        if (navigator.vibrate) navigator.vibrate(50);
                        openSettings();
                    }, 1500); // 1.5s long press
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (settingsTimer) {
                    const mX = Math.abs(e.touches[0].clientX - sX);
                    const mY = Math.abs(e.touches[0].clientY - sY);
                    if (mX > 20 || mY > 20) {
                        clearTimeout(settingsTimer);
                        settingsTimer = null;
                        // log("Touch cancel (move)"); // Trop verbeux
                    }
                }
            }, { passive: true });

            document.addEventListener('touchend', () => {
                if (settingsTimer) {
                    clearTimeout(settingsTimer);
                    settingsTimer = null;
                    log("Touch end (trop t√¥t)");
                }
            });

            // === MISSING FUNCTIONS RESTORED ===
            function saveAll() {
                socket.emit('update-state', state);
                // Visual feedback
                const btn = document.querySelector('button[onclick="saveAll()"]');
                if (btn) {
                    const originalText = btn.innerText;
                    btn.innerText = "‚úÖ SAUVEGARD√â";
                    setTimeout(() => btn.innerText = originalText, 2000);
                }
                if (navigator.vibrate) navigator.vibrate(50);
            }

            function handleFileUpload(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.logoUrl = e.target.result;
                    state.logoVisible = true;
                    updateUI();
                    socket.emit('update-state', state);
                };
                reader.readAsDataURL(file);
            }

            function previewLogo(url) {
                state.logoUrl = url;
                state.logoVisible = !!url;
                updateUI();
            }

            function updateZoom(val) {
                state.logoZoom = val;
                document.getElementById('zoom-val').innerText = val;
                socket.emit('update-state', state);
            }

            function switchRoutine(index) {
                state.activeRoutineIndex = parseInt(index);
                renderSteps();
                socket.emit('update-state', state);
                updateUI();
            }

            function toggleStep(idx) {
                state.routines[state.activeRoutineIndex].steps[idx].active = !state.routines[state.activeRoutineIndex].steps[idx].active;
                socket.emit('update-state', state);
                renderSteps();
            }

            function editStep(idx) {
                const step = state.routines[state.activeRoutineIndex].steps[idx];
                const val = prompt(`Modifier valeur pour ${step.type} (duree: ${step.duration}ms):`, step.value || '');
                if (val !== null) {
                    step.value = val;
                    const dur = prompt("Modifier dur√©e (ms):", step.duration);
                    if (dur) step.duration = parseInt(dur);
                    socket.emit('update-state', state);
                    renderSteps();
                }
            }


        </script>
    </div><!-- End of Wrapper -->
</body>

</html>